## ACESSAR O MYSQL DO DOCKER ##
docker exec -it mysql-thygas-coins mysql -u root -p

## CRIAR DATABASE NO MYSQL ##
CREATE DATABASE api_ecommerce_db;

## ACESSAR O DATABASE CRIADO ##
USE api_ecommerce_db;

## CRIAR TABELAS ##
CREATE TABLE categories (
    id VARCHAR(32) PRIMARY KEY,        -- CUID
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ,
    disabled_at TIMESTAMPTZ,
    deleted_at TIMESTAMPTZ,
    name VARCHAR(255) NOT NULL,
    description VARCHAR(510),
    image VARCHAR(255)
);

CREATE INDEX idx_categories_name ON categories (name);
CREATE INDEX idx_categories_name_lower ON categories (LOWER(name));
CREATE EXTENSION IF NOT EXISTS pg_trgm;
CREATE INDEX idx_categories_name_trgm ON categories USING GIN (name gin_trgm_ops);
CREATE INDEX idx_categories_name_active ON categories (name) WHERE deleted_at IS NULL;

## Função da trigger ##
CREATE OR REPLACE FUNCTION set_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

## Trigger que atualiza updated_at automaticamente ##
CREATE TRIGGER trg_set_updated_at
BEFORE UPDATE ON categories
FOR EACH ROW
EXECUTE FUNCTION set_updated_at();


## Alterar default da coluna image em categories ##
ALTER TABLE categories
    ALTER COLUMN image SET DEFAULT 'https://pub-ed3dc7ef7c4246a1920ae855cc06d5e4.r2.dev/categories/category-default.jpg';

CREATE TABLE products (
    id VARCHAR(32) PRIMARY KEY,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ,
    disabled_at TIMESTAMPTZ,
    deleted_at TIMESTAMPTZ,
    name VARCHAR(255) NOT NULL,
    description VARCHAR(510),
    image VARCHAR(255),
    price DECIMAL(10, 2) NOT NULL,
    stock_quantity INTEGER NOT NULL DEFAULT 0,
    category_id VARCHAR(32),
    sku VARCHAR(100) UNIQUE,
    weight DECIMAL(10, 3),
    dimensions VARCHAR(100),
    is_featured BOOLEAN DEFAULT FALSE,
    FOREIGN KEY (category_id) REFERENCES categories(id) ON DELETE SET NULL
);

CREATE INDEX idx_products_name ON products (name);
CREATE INDEX idx_products_name_lower ON products (LOWER(name));
CREATE INDEX idx_products_name_trgm ON products USING GIN (name gin_trgm_ops);
CREATE INDEX idx_products_name_active ON products (name) WHERE deleted_at IS NULL;
CREATE INDEX idx_products_category_id ON products (category_id);
CREATE INDEX idx_products_sku ON products (sku);
CREATE INDEX idx_products_price ON products (price);
CREATE INDEX idx_products_is_featured ON products (is_featured) WHERE is_featured = TRUE AND deleted_at IS NULL;

## Trigger que atualiza updated_at automaticamente em products ##
CREATE TRIGGER trg_set_updated_at_products
BEFORE UPDATE ON products
FOR EACH ROW
EXECUTE FUNCTION set_updated_at();

## Alterar default da coluna image em products ##
ALTER TABLE products
    ALTER COLUMN image SET DEFAULT 'https://pub-ed3dc7ef7c4246a1920ae855cc06d5e4.r2.dev/products/product-default.jpg';

##### CREATE USER #####
CREATE EXTENSION IF NOT EXISTS pg_trgm;

CREATE TABLE users (
    id VARCHAR(32) PRIMARY KEY,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ,
    disabled_at TIMESTAMPTZ,
    deleted_at TIMESTAMPTZ,
    name VARCHAR(255) NOT NULL,
    image VARCHAR(255) NOT NULL DEFAULT
        'https://pub-ed3dc7ef7c4246a1920ae855cc06d5e4.r2.dev/products/product-default.jpg',
    email VARCHAR(255) NOT NULL,
    email_verified_at TIMESTAMPTZ,
    password_hash VARCHAR(255) NOT NULL,
    CONSTRAINT uq_users_email UNIQUE (email),
    CONSTRAINT chk_users_email_lower CHECK (email = LOWER(email))
);

CREATE INDEX idx_users_name_trgm
ON users USING GIN (name gin_trgm_ops)
WHERE deleted_at IS NULL;

CREATE INDEX idx_users_email_active
ON users (email)
WHERE deleted_at IS NULL;

CREATE INDEX idx_users_active
ON users (is_active)
WHERE deleted_at IS NULL;

CREATE TRIGGER trg_set_updated_at_users
BEFORE UPDATE ON users
FOR EACH ROW
EXECUTE FUNCTION set_updated_at();

UPDATE users
SET deleted_at = NOW(), is_active = FALSE
WHERE id = :user_id;

CREATE UNIQUE INDEX uq_users_email_not_deleted
ON users (email)
WHERE deleted_at IS NULL;
